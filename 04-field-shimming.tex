\chapter {Shimming the Magnetic Field}

\section{Hardware}

\subsection{The Storage Ring}

The \gmtwo Storage Ring was designed with a lofty goal of 1 ppm peak-to-peak magnetic field uniformity in the muon storage volume.  The pole surface was crafted with some of the purest steel and highest precision flatness that was available at the time. The purity of the steel improves uniformity by normalizing the magnetic saturation effects across the pole surface.  The flatness uniformity directly improves the gap uniformity which is a primary order proxy for the magnetic field strength between the two pole surfaces. The pole pieces have adjustable mounts called "pole feet" which offer leverage on reshaping the pole surface by small amounts. 

\todo{add image of poles+gap}

The storage ring was also engineered with several built-in knobs to the tune the field locally in azimuth.  The storage ring includes 864 wedge shims, i.e. 12 per pole piece, which occupy the space between the pole pieces and the main yoke.  They have an angled design in order to have an effect on both the normal quadrupole and dipole field.  Each pole piece has two steel runners on the outside of the uniform, flat surface.  With top and bottom sets of so-called edge shims, the design imparted a complex handle on higher order, more than quadrupole, multipoles. The last and simplest shimming knob are the steel plates dubbed the top hats.  The top hats run in 15 degree segments, two per yoke, top and bottom.  Adjusting the top hats can induce a large effect on the average field in its respective region.  

\todo{add images of shims}

After the Big Move, the storage ring was reassembled with some care to bring it into a state similar to the final E821 state of the ring with hopes that the field shimming time could be reduced.  The magnetic field produced when the ring was repowered at Fermilab was similar to the initial field at Brookhaven, so the reassembly was unfortunately not a big leg up.  The field team found themselves at a fresh start.

\subsection{Measurement Devices}

\subsubsection{Shimming Cart}
The main tool used in the rough shimming process was a platform full of equipment that fit between the pole surfaces all around the ring.  The shimming cart measured the magnetic field, the pole gap and the local temperature.  The magnetic field was measured through a matrix of 25 pNMR probes secured in a frame which defines an azimuthal plane of the size of the cross-section of the muon storage volume. The cart also possesses four capacitive distance sensors which measure the pole gap at the inner and outer radius.  A temperature probe was placed on the cart near the pNMR probes.  All materials were chosen to make as small of a magnetic perturbation as possible.  The cart traversed the ring with the help of a stepper motor and flexible cabling to impart steps forward.  At each location the probes and capacitec made measurements, then the cart moved on.  A full scan of the ring with the standard step size took about 3 hours.

\todo{engineering diagram of cart}

\subsection{Laser Tracker}
The shimming cart was equipped with four reflective corner cube mirrors which could be tracked with a laser tracker.  A commercial, API laser tracker was installed in the center of the ring and used to establish the position of the measurements taken by the shimming cart.  The most important value from the laser tracker was the azimuthal angle, $\phi$, but the device also reported height, $z$, and radius, $r$.  The laser tracker measured with precision, $\delta\phi \approx \SI{0.1}{\deg}$, $\delta r \approx \SI{0.1}{\milli\meter}$, and $\delta z \approx \SI{25}{\micro\meter}$ \note{verify these}.

\subsection{Tilt Sensor}
A custom tilt sensor built by \uw was another important tool.  The tilt sensor consisted of a \SI{29}{\cm} by \SI{12}{\cm} aluminum base plate with two mounted electrolytic bubble levels.  It had three spherical feet both top and bottom to define a consistent plane.  The tilt sensors were able to read out at a precision of about \SI{2}{\micro\radian}.  The sensors take more than 30 minutes to fully settle though, so most measurements were made with lower precision to reduce measurement time.

\todo{add calibration images}
\section{Adjustments}

Though it was clear from the start that there was much work to be done in order to shim the field, the path forward was not as obvious.  After gauging the measurement devices and subsequently the state of the storage field, it was decided that several stages of adjustments were necessary.  The first stage was leveling the ring with respect to gravity.  The second was a full iteration of adjusting the feet on each pole piece.  The third was a survey of whether or not high order multipole adjustments via edge shims were needed.  The fourth was optimization of the field using the built-in shimming kit.  And, the final round of adjustments was thhe implementation of a surface of measured iron segments which really pushed us into new territory from the E821 experiment.

\subsection{Ring Leveling}
At an intermediate point in the shimming process, it became clear that the plane of the storage ring and the plane defined by gravity were not aligned.  Furthermore measurements indicated that that plane of the ring was different from the plane that had been measured upon construction of the ring.  It would seem that the floor had settled a millimeter or two.  In addition to correcting the ring alignment, the adjustment procedure also afforded an opportunity to see the effect that future floot settling might have on the magnetic field.

The laser data clearly shows the tilt plane of storage ring (see figure \ref{fig:ring-leveling-plan}).  The deviations of the ring plane were about \SI{1}{\milli\meter} from the average value.  The tilt plane was also visible in the radial tilts of the poles around the ring.  An adjustment plan was crafted to fix the height and radial tilts of each yoke.  The plan to to level the ring used only adjustments on the legs of each yoke. With yoke leg adjustments the interface between each yoke remains fixed, so the adjustment plan locked yokes together on the boundaries.  The plan used linear fits of the laser in small angular windows on each side of the yoke boundaries to determine the target height for the inside of the yoke.  The radial tilt measurements were used to calculate differential adjustments between the inner and outer legs of a yoke while of course minding the fixed interface. 

\begin{figure}
\includegraphics[width=0.9\linewidth]{fig/ring-leveling-plan.png}
\caption{The ring plane had a rather large tilt plane built into it.  The tilt plane was removed using only adjustments on the yoke legs.  The adjustments were devised both bring the ring plane close to the plane defined by gravity and rein in yokes with wild radial tilts.}
\label{fig:ring-leveling-plan}
\end{figure}

A team of mechanical engineers led by Eric Voirin performed the yoke adjustments.  Adjustments were made incrementally in steps of approximately \SI{100}{\micro\meter}, the reason being an effort to minimize differential stress between the yokes.  During the process, the shimming laser tracker was replaced with the alignment team Hamar laser.  Progress was measured periodically using a floating corner cube placed at three specific pole positions around the ring.  The measurements with a sine fit overlay are depicted in figure \ref{fig:ring-leveling-steps}.  They give a strong sense of the success of the procedure.  The whole process took two days to affect the initial plan and one more day of minor adjustments.

\begin{figure}
\includegraphics[width=0.9\linewidth]{fig/ring-leveling-steps.png}
\caption{The image depicts iterations of yoke leg adjustments made to level the storage ring.  Three locations around the ring were measured using the Hamar laser system.  Those locations are represented by the points in the plot.  The points were fit to sine wait to illustrate how the leveling effects in the unmeasured sections of the ring.}
\label{fig:ring-leveling-steps}
\end{figure}

The ring leveling was very successful.  Yoke leg adjustments managed to remove the tilt plane from the ring and help flatten the radial tilt of the poles (\ref{fig:ring-leveling-final}.  After ring leveling the ring plane was flat to about \SI{300}{\micro\meter}.  While flattening the ring simplified general \gmtwo detector alignment and made future adjustments simpler for the field team, one of the most important results was the effect on the field.  In theory, the field should not depend on the ring plane or the relative yoke orientations, but the ring leveling provided an opportunity to symbiotically measure the effect.  Figure \ref{fig:ring-leveling-field-effect} contains a plot of the difference between the azimuthally averaged field before and after leveling.  There is a small change in the average dipole field which is hard to ascribe a cause with certainty (field drift, adjusted hysteresis from moving yokes, etc.).  The higher order symmetries remain essentially unchanged though, and that is the important result.

\begin{figure}
\includegraphics[width=0.9\linewidth]{fig/ring-leveling-final.png}
\caption{The image shows the original ring plane in red and the final ring plane in green.  The plot speaks for itself as to the success of leveling the plane of the ring.}
\label{fig:ring-leveling-final}
\end{figure}

\begin{figure}
\includegraphics[width=0.9\linewidth]{fig/ring-leveling-field-effects.png}
\caption{Another important test from the ring leveling experience is the field effects.  The plots show the magnetic field averaged over the azimuth before and after ring leveling.  The takeaway is a small possible effect on the average field (though this could also be drift and other effects), and virtually no effect on higher order multiples.  If necessary, the ring could be leveled again without worry of destroying the field uniformity.}
\label{fig:ring-leveling-field-effects}
\end{figure}

\subsection{Pole Moves}

Adjusting the orientation and shape of the pole pieces was the first substantial stage in optimizing the uniformity of \gmtwo storage field.  Having previously established calibrations for the field effects,  the field team tested the model on some of the most aberrant poles with some success.  It quickly became clear that we could not make planned adjustments on a pole-by-pole basis though.  The cost of adjusting a single pole was fairly large taking hours to crane out, replace shims in the pole feet, and crane back in, so the plan needed to do as much as possible with a single pass of pole adjustments.  What was needed was a global model of the pole geometry.

\subsubsection{The Bottom Pole Model}

Building an accurate global model of the pole surfaces was not a simple task.  We had four possible measurements to use: the laser tracker, the tilt sensor, the capacitec sensors, and the field measurements.  The team elected to ignore field data as it was difficult to decouple the effect of current shim positions, impurities, and perturbations from hardware that broke the azimuthal symmetry.  In the right combination, the sensor data is just enough to build a complete model of the pole surfaces.  Let's build the model from the bottom poles up.

The bottom poles were characterized using a synergistic combination of tilt sensor data and laser measurements.  The shimming cart rode on the bottom poles along the edge shims at the inner radius of the pole \note{reference shimming cart figure}. The height value reported by the laser then directly represented the the inner radius of the bottom pole surface.  From the inner radius of the bottom pole, the outer radius can be extrapolated from tilt sensor measurements.  Each pole was broadly characterized with a radial and azimuthal tilt measurement taken from the center defining a rough plane for the pole.  The pole interfaces were characterized with a set of three tilt measurements near the gap: one on the upstream pole, one straddling both poles, and one on the downstream pole.  The pole step measurement is very sensitive to average elevation changes and rotation mismatches between poles.  The pole model folds the laser height data in with a radial tilt model that smoothly varies across the pole, and then, restricts the pole interfaces with the pole step tilt measurements.  An entire global plan for the bottom pole moves was made from this model, see figure \ref{fig:pole-moves-bottom-plan}

\begin{figure}
\includegraphics[width=0.9\linewidth]{fig/pole-moves-bottom-plan}
\caption{The plot visually represents the plan for adjusting pole feet using circles for the inner feet, triangles for the outer feet against their azimuth location.  The laser data which anchored the pole surface model is also plotted in scatter form.  Notice that the inner feet changes are minor adjustments on the laser data, and the outer feet changes fold in the radial tilt measurements on the poles.}
\label{fig:bottom-pole-adjustment-plan}
\end{figure}

\subsubsection{The Top Pole Model}

The model for the top pole surfaces had to be constructed on the foundation of the bottom pole model.  While this situation was not ideal, it did work out.  Starting from the model for the bottom poles, the sum of the two inner capacitec measurements acted as a proxy for the gap between the upper and lower poles, so the sum of the bottom pole model inner radius and the two inner capacitec values represented the inner band of the top pole model.  With an established value for the inner band of the top poles, the same extrapolation to the outer band and pole interfaces was employed as with the bottom poles.  The top and bottom outer bands could then be used to valid the pole model overall by comparing the predicted gap in the outer bands to the gap measured by the outer capacitec sensors \todo{add validation plot}.  The model was of course not perfect, but ready for a full sweep of pole moves, top and bottom.

\subsubsection{First Round}

Implementing pole adjustments proved to be an involved procedure.  A typical day went as follows: John Najdzion would come in early around 6am and carefully transport 3 or 4 poles onto work blocks, the field team would come with micrometers and assorted shimstock to implemented a prescription of changes to 1/4 mil (\SI{6}{\micro\meter}), and the John Najdzion \note{spelling} would reseat the poles into the ring.  The first full round of pole movements took over a month to implement.  The results speak for themselves though.

\begin{figure}
\includegraphics[width=0.9\linewidth]{fig/pole-moves-bottom-tilts}
\caption{The radial tilts in red and the azimuthal tilts in green of the bottom poles are shown before pole moves in lighter color and after in darkened color.  The dotted horizontal bands shown represent the target range for the tilt uniformity.  The improvement from pole movements is clear.}
\label{fig:pole-moves-bottom-tilts}
\end{figure}

\subsubsection{Round Two}

The model was not perfect and nor was the predictability of adjusting pole feet.  The results from the first pass at pole adjustments were good, but a second round of tweaks really completed the picture.  The primary goal of the second pass at pole adjustments was to elminate large extant deviations and close remaining pole steps in the center of each pole interface to within \SI{0.5}{mil} (\SI{12.5}{\micro\meter}.  Many of the adjustments were done without removal of the poles, since the front pole feet were accessible after untorquing the super bolts and propping the weight of the bottom poles up on a jackstand of sorts.  The jackstand was an adjustable pole foot prototype developed duing the E821 era.  The top poles did not require a jackstand, since gravity assisted in spacing the poles from the yoke in that case.  In each specific case, the field team weighed the value of retrying a full pole adjustment against small tweaks on the inner feet.

\subsubsection{Final Results}

While still making pole adjustments, the field team began to implement shim adjustments, so the entirety of the field improvements show in figure \ref{fig:pole-moves-field-comparison} is not due to the pole moves.  The main improvements from the pole moves is the elminations of sharp spikes in the average field that were caused by large elevation changes in the pole surface due to pole interface mismatches, along with the elimination of the the average normal quadruopole moment by adjusting the radial tilts top and bottom.

\begin{figure}
\includegraphics[width=0.9\linewidth]{fig/pole-moves-field-comparison}
\caption{The azimuthally average field plots are shown with field prior to pole moves on the left and field after on the right.  A little care is necessary in interpreting attributions for the improvements though, because some shim adjustments were made before the pole movements had completed.  The major improvement shown in the plot is the elimination of the \SI{-18}{ppm} normal quadrupole moment.  Some improvement in the average skew quadropole is also evident.}
\label{fig:pole-moves-field-comparison}
\end{figure}

\subsection{Edge Shim Study}

The edge shims are the strongest lever available to the field team for controlling multipoles higher than quadrupoles.  However, the edge shims are not easy to adjust.  The full process involves ordering shims that are thicker than needed, calibrating the effects of sanding down the edge shims, determinining the desired thicknesses, sending the edge shims in to be refined, and repeated as many times are needed.  The process is costly and time consuming, and the E989 field team wanted to avoid it.  They needed to determine that the benefits were not necessary though.

\subsubsection{Calibration}

Several prototype steel shims were ordered for calibration and proof of principle testing of edge shim adjustments.  One prototype edge shim of each type (inner lower, outer lower, inner upper, and outer upper) was installed in the place of the current edge shim one different poles around the ring.  The different in thickness was measured and used to calibrate the multipole effects of the edge shims.  The results are shown figure \ref{fig:edge-shim-model}. In addition to E821 style legwork, the E989 team set up some tests using capton as spacer under edge shims in lieu of grinding down shims and some tests using steel shimstock in lieu of implementing thicker edge shims.

\begin{figure}
\includegraphics[width=0.9\linewidth]{fig/edge-shim-model}
\caption{The models for edge shims derived from calibration data.  Each type of edge shim induced different higher order multipole effects.  The effect shown is for a \SI{1}{\milli\meter} change. \note{remake if needed}}
\label{fig:edge-shim-model}
\end{figure}

\todo{add figure for spacer/shim effects}

\subsubsection{Edgelets}

An idea that arose duing edge shim calibration was to implement edge shims in a more localized form.  The atomic size was chosen to be one degree segments and steel could only be added, but the approach seemed promising.  The model was based on the full edge shim model with edge effects being compartmentalized into one degree segments.  The edgelet shim model went forward to attempt to fix the most aberrant, localized regions of multipoles.  The implementation did not live up to earlier promise shown by the approach though which signifies a need for more model complexity than originally expected. In the end the edglet patching model was abandoned.

\begin{figure}
\includegraphics[width=0.9\linewidth]{fig/edge-shim-edgelets}
\caption{The figure shows predicted effects of the edgelet model in green and measured results of implemenation in red.  The model proved to be qualitatively correct, but was in need of more accurate calibration or increased complexity to be precise on the part-per-million level.}
\label{fig:edge-shim-edgelets}
\end{figure}

\subsubsection{Implementation}

The final footprint of the edge shims remained nearly identical to the initial footprint of the edge shims.  Additional steel shims of a few mils were added in a few sections, but for the most part no adjustments to the edge shims were deemed necessary.  One of the major drivers for acting with a light touch on edge was promise of optimization using steel lamination modeling.

\subsection{Shim Optimization}

For the purpose of this section, shim optimization refers to optimizing the easily tunable shimming knobs, the top hats and the wedge shims. The top hats affect solely the average field and the wedge shims have an effect on the dipole and the quadrupole fields making these knobs a natural last stage in shimming the storage magnetic by design.

\subsubsection{Calibration}

The top hats were nailed down fairly early.  The data taken in figure \ref{shim-optimization-top-hat-cal} was actually taken using the Metrolab and not the shimming cart \note{verify this}.  The wedge shim calibration proved more difficult to pin down exactly.  One of the confounding factors came from the constraint that the field must be powered down, the wedge shim adjusted and then the field re-powered to measure the effect.  Field drift on the order of a few ppm was normal, but this made the calibrations looking for changes on the order of 10s of ppm difficult, especially when the range was narrow such as single wedge calibrations.  With these difficulties, it was necessary to calibrate, model, implement and validate the wedge shim a few iterations before the model reached acceptable precision.

\begin{figure}
\includegraphics[width=0.9\linewidth]{fig/shim-optimization-top-hat-cal}
\caption{The calibration for the top hat shims.  Between the two days that data was collected a \SI{0.5}{\milli\meter} spacer was placed under one of the top hats.  Normalized by size and adding a factor two for changes that would be done on both top and bottom hats, the calibration comes out to \SI{338}{ppm\per\centi\meter} with an RMS width of \SI{20.74}{\degree}.}
\label{fig:shim-optimization-top-hat-cal}
\end{figure}

\todo{add figure for wedge shim calibration}

\subsubsection{Field Model}

The field optimization routine took the problem and cast it into a standard it into a standard linear framework.  If we want the problem to be linear, then each knob needs to have a single dependent variable.  Fortunately, the field shimming problem lends itself to the linear framework nicely if we cast it in terms of multipoles

\[
\mathbf{y} = \mathbf{M} \mathbf{x} + \mathbf{b}
\]

where $\mathbf{y}$ is the stack of residual field multipoles, 

\[
\mathbf{y} = \begin{bmatrix}
\vec{\delta B}_{dipole}    \\
\vec{\delta B}_{nquad} \\
\vec{\delta B}_{squad} \\
\vec{\delta B}_{nsext} \\ 
\vec{\delta B}_{ssext} \\
\vdots
\end{bmatrix}
\]

$\mathbf{M}$ contains the shim models, 

\[
\mathbf{M} = \begin{bmatrix}
\vec{B}_{top-hat-01,dipole} & \hdots & \vec{B}_{wedge-01,dipole} & \hdots \\
\vec{B}_{top-hat-01,nquad}  & \hdots & \vec{B}_{wedge-01,nquad} & \hdots \\
\vec{B}_{top-hat-01,squad}  & \hdots & \vec{B}_{wedge-01,squad} & \hdots \\
\vec{B}_{top-hat-01,nsext}  & \hdots & \vec{B}_{wedge-01,nsext} & \hdots \\ 
\vec{B}_{top-hat-01,ssext}  & \hdots & \vec{B}_{wedge-01,ssext} & \ddots \\
\vdots & \vdots & \vdots & \vdots
\end{bmatrix}
\]

$\mathbf{x}$ is the dependent variable, shim position, 

\[
\mathbf{x} = \begin{bmatrix}
\vec{x}_{top-hat-01} \\
\vdots \\
\vec{x}_{wedge-01} \\
\vdots \\
\vec{x}_{edge-01} \\
\vdots
\end{bmatrix}
\]

and b is most recently measured field values.

\[
\mathbf{b} = \begin{bmatrix}
\vec{B}_{dipole} \\
\vec{B}_{nquad}  \\
\vec{B}_{squad}  \\
\vec{B}_{nsext}  \\ 
\vec{B}_{ssext}  \\
\vdots
\end{bmatrix}
\]

Solving the linear optimization problem is really quite simple, so the harder part is defining calibrated shim models and plugging into the linear format.

Each shimming knob underwent calibration measurements, simulations, and had a precedent from E821.  The top hat calibration was used to create a gaussian model of the field effect with

\todo{insert table of model parameters}

The model was run through a linear least squares optimization scheme.  Each knob was restricted to be within a finite range, and each multipole receieved a weight used to tune the optimization.  The current setting of each shim had to be known beforehand also, and these were measured by hand.  The resulting model was useful in deciding the necessity of adjusting edge shims (figure \ref{fig:field-model-edge-adjustments}) and iterating on the easily tunable shims to optimize the storage field (figure \ref{fig:field-model-example-plan}).

\begin{figure}
\label{fig:field-model-edge-adjustments}
%\includegraphics[width=0.9\linewidth]{fig/field-model-edge-adjustments}
\caption{\todo{generate this}}
\end{figure}

\begin{figure}
\label{fig:field-model-example-plan}
\includegraphics[width=0.9\linewidth]{fig/field-model-example-plan}
\caption{An example of one of the later rounds of shim adjustments.  The wedge calibration had been tuned in properly, and as one can see, the optimization predicted strong improvements in the dipole uniformity with the standard deviation going from \SI{90}{ppm} to \SI{40}{ppm} and the normal quadrupole central value and uniformity improving to \SI{-0.3}{ppm} and \SI{7.6}{ppm} respectively. \todo{check these results}}
\end{figure}

\subsubsection{Results}

The end result of lots of hardwork from the field team was impressive.  The average field uniformity had gone from a standard deviation of \SI{1000}{ppm} \note{this is a guess, calculate actual} to \SI{40}{ppm}.  Similarly most of the higher order multipoles had been shrunk to values below \SI{1}{ppm}.  At the end of optimizing the field using the built-in shimming knobs, the field state was similar to that of E821.  Depending on which year and when you looked at the field data, the E989 looked better in some respects, but not enough.

\begin{figure}
\label{fig:field-model-results}
\includegraphics[width=0.9\linewidth]{fig/field-model-results}
\caption{The final rough shimming dipole field result for E989 in red, compare with the PRD field standard deviation of \SI{30}{ppm}.  The horizontal bands indicated \SI{\pm 25}{ppm} around the central value which was target for E989.  And, below the azimuthally average multipole content of the field.  The results are on par with the running field from E821.}
\end{figure}

\subsection{Laminations}

The design flexibility of the storage magnet fell short of the uniformity goals of E989, so the field team had to expand the shimming infrastructure.  The next stage of shimming alterations placed thin, \SIrange{25}{50}{\micro\meter}, strips of iron onto the pole surfaces.  In all over 8,000 strips of iron were placed to adjust the field uniformity to an unprecedented level.  The process was arduous and involved a large cast of characters to come to fruition.  8 high school students, 2 undergrad, 4 graduate students, 2 post-docs, 1 high school teacher, 1 professor, 2 research scientists, 2 technical engineers, and one project manager lent their efforts to make the lamination procedure successful \note{confirm numbers with others}.

\subsubsection{Model}

David Kawall, a Professor at UMass Amherst, concieved the model for optimization using iron laminations.  The model treated the metal strips as thin, fully magnetized iron dipoles with several orders of magnetic images appearing inside the pole piece.  The model split each pole into 41 azimuthal sections and 3 radial sections to give a lever on both higher order multipoles and variations of the field local in azimuth.  Another concern about strong gradients from the large lamination edges being a detriment to the FID signal in the fixed probe system was alleviated by designing an azimuthal grated pattern denoted as a "picket fence" region.  The final design was akin to the simple diagram in figure \ref{fig:laminations-simple-design}.

\begin{figure}
\label{fig:laminations-simple-design}
\includegraphics[width=0.9\linewidth]{fig/laminations-simple-design}
\caption{A simplified version of the lamination patterns laid down on pole pieces.  The real laminations had 41 azimuthal regions and two picket fences per pole piece.}
\end{figure}

\subsubsection{Calibration}

The lamination model had a few parameters that were intentionally undetermined.  The parameters could be characterized by calibrating with pNMR measurements.  Cutting a strip from the iron shimstock was the first step.  The strips were typically the full width of the sheet, 12", and a few \si{\centi\meter} wide.  The dimensions were well all measured and the sample was massed.  Once the sample had been physically characterized, it was taped to a G10 sheet and affixed to a pole surface.  After the sample was stabilized the shimming platform ran over the sample while measuring the field perturbations with its pNMR probes as shown in figure \ref{fig:laminations-calibration}.  The result was compared to predictions made by the foil model with adjustments allowed for the magnetic saturation and order of image dipoles to improve the model.  The calibration process was performed for many batches of shimstock to ensure uniformity.

\begin{figure}
\label{fig:laminations-calibration}
\includegraphics[width=0.9\linewidth]{fig/laminations-calibration}
\caption{The calibration results with the raw measurements before adding the calibration strip in red and after in blue.  The difference is compared to the model prediction in the lower plot which shows excellent agreement.  All values are field perturbation at the location of the central pNMR probe in the shimming cart.}
\end{figure}

\subsubsection{Implementation}

The procedure between modeling the laminations, and fastening them onto the pole surface was not so simple.  First, some of the high spikes in the field were lowered with the wedge shims, because the laminations could only add to the current field value.  Then, outputs from the lamination simulation were examined to create a target distribution of foils to fabricate with a laser cutter.  The individual foils and picket fences needed to be cleaned, massed, sorted and drafted into the lamination plan.  Each lamination board, made from g10 plastic, was cut, outfitted with the proper laminations and picket fences, and affixed to the pole pieces using epoxy.

\todo{paragraph on wedge adjustments to lower field}

Foil production was a multi-stage process.  The initial set of foils were cut by hand using a paper trimmer at FNAL.  The process was slow and inaccurate in producing the desired foil masses.  At the University of Washington, a laser cutting machine accelerated process by printing hundreds of strips per hour.  The patterns printed by the laser cutter were designed in Mathematica by Martin Fertl to produce a distribution that largely overlapped with the foil distribution needed to appease the lamination optimization.  The laser cutter was used once again to cut the picket fence designs.  

\note{maybe add examples of the templates used in the laser cutter}

The laser cut foils were then shipped onward to the next stage of lamination production.  At FNAL, the foils were cleaned in alcohol to removed as much plastic residue from the laser cutting process.  During laser cutting the shimstock was lain flat on a substrate of plastic and thick paper of which the laser melted and spattered some onto the metal.  The cleaning was important, because the most important aspect of the strips was the total mass of the strip and residue would disturb the mass measurement.  After cleaning each strip was massed to the nearest \SI{0.1}{\milli\gram} and manually histogrammed into a set of cups.

\note{maybe add image of foil cups}

The next stage involved actually placing the foils onto G10 laminations shaped like pole pieces.  The foils were inventoried using a shared spreadsheet, and another team of workers tracked the inventory matching the prescriptions for each individual pole lamination.  When a full prescription was available, the strips were affixed to the lamination using very strong and thin double sided tape (3M-9485PC).  The finished pieces were then stored until completed tops and bottoms were paired and the relevant area of the ring was ready for installation.

The last stage of the lamination process was installation onto the pole surface.  Testing found that double sided tape was insufficient to affix the laminations stably onto the pole surfaces, so stycast epoxy was employed instead.  The epoxy was mixed in a controlled area, applied generously to the laminations. Then, the laminations were azimuthally aligned with the ring clocking.  And finally a makeshift rig was assembled to keep both top and bottom laminations under even pressure while the epoxy cured.  Figure \ref{fig:laminations-epoxy-rig} depicts the final stage in progress and post completion.

\begin{figure}
\label{fig:laminations-epoxy-rig}
\includegraphics[width=0.9\linewidth]{fig/laminations-epoxy-rig}
\caption{The left image shows the full rig used to apply pressure and stabilize the laminations while the epoxy cured over \SIrange{4}{6}{\hour}.  The right image shows the finalized laminations affixed to the pole surfaces.}
\end{figure}

\subsubsection{Effects}

The results from the laminations really speak for themselves.  In figure \ref{fig:laminations-yoke-e-dipole}, the improvement in the Yoke E region is clear compared to the other regions in the current iteration, and the E821 PRD field.  A similar improvement is seen in figure \ref{fig:laminations-yoke-e-multipoles} which stacks the multipoles weighted by their E821 beam presence.  The effect of the laminations is quite impressive once again.

\begin{figure}
\label{fig:laminations-yoke-e-dipole}
\includegraphics[width=0.9\linewidth]{fig/laminations-yoke-e-dipole}
\caption{The E989 dipole field after installing laminations over part of the ring is show in red, and the E821 PRD dipole field is shown in blue for reference.  The azimuthally localized improvement from the laminations is substantial.}
\end{figure}

\begin{figure}
\label{fig:laminations-yoke-e-multipoles}
\includegraphics[width=0.9\linewidth]{fig/laminations-yoke-e-multipoles}
\caption{The E989 field multipoles after installing laminations over part of the ring are weighted by their E821 beam contributions and stacked as a proxy for the total error contribution from higher order multipoles in each azimuthal section of the ring.}
\end{figure}

\section{Results}

The field team started the shimming journey with the goal of a two-fold improvement over the E821.  In the dipole field, that target is a peak-to-peak variation of \SI{50}{ppm}. And in the field multipoles, that target is an azimuthal average under \SI{1}{ppm} \note{probably revise for rough shimming phase}.

\subsection{Design Shimming}

The first stage of progress comes from the set of built-in shimming knobs.  The average field is shown in figure \ref{fig:results-shims-dipole-final} as a comparison with the E821 PRD dipole field.  The field at this point was not a large improvment over the efforts of the E821 team.  The peak-to-peak variation after this stage is \SI{100}{ppm} \note{check}.  The 

\begin{figure}
\label{fig:results-shims-dipole-final}
\includegraphics[width=0.9\linewidth]{fig/results-shims-dipole-final}
\caption{The final rough shimming result for E989 in red compared with the PRD field plot for E821.  The horizontal bands indicate \SI{\pm 25}{ppm} around the central value which was target for E989.  The result field beat the target by a factor of two and E821 field results by a factor of three \note{check values}.}
\end{figure}

\begin{figure}
\label{fig:results-shims-multipoles-final}
\includegraphics[width=0.9\linewidth]{fig/results-shims-multipoles-final}
\caption{The final rough shimming result for E989 in red compared with the PRD field plot for E821.  The horizontal bands indicate \SI{\pm 25}{ppm} around the central value which was target for E989.  The result field beat the target by a factor of two and E821 field results by a factor of three \note{check values}.}
\end{figure}

\subsection{Additional Shimming}

The built-in knobs were not effective enough to reach the goals set forth for E989.  To push beyond the design limits of the \gmtwo storage ring, the field team implemented an intricate set of laminations to cover the pole surfaces and shim the field with more local precision in azimuth.  The implementation of the laminations pushed the dipole field uniformity to \SI{30}{ppm}, well below the target range.  The results are depicted in figure \ref{fig:results-laminations-dipole-final}.

\begin{figure}
\label{fig:results-laminations-dipole-final}
\includegraphics[width=0.9\linewidth]{fig/results-laminations-dipole-final}
\caption{The final rough shimming result for E989 in red compared with the PRD field plot for E821.  The horizontal bands indicate \SI{\pm 25}{ppm} around the central value which was target for E989.  The result field beat the target by a factor of two and E821 field results by a factor of three \note{check values}.}
\end{figure}

The results for higher order field multipoles were similarly impressive.  The azimuthal variation is largely suppressed.  The plot in figure \ref{ig:results-laminations-multipoles-final} shows each multipole weighted by the E821 beam composition for that particular multipole.  A few of the multipoles have means that remain relatively large (a few ppm), but these do not appear in the figure.  The reason for this is that those multipoles, mostly skew sextupole, were supressed in the distribution of muons in E821 and are expected to be similarly suppressed in E989.  The average value can still be adjusted by the active shimming mechanisms, the surface current coils.  The surface current coil system was not commissioned at the time rough shimming ended.

\begin{figure}
\label{fig:results-laminations-multipoles-final}
\includegraphics[width=0.9\linewidth]{fig/results-laminations-multipoles-final}
\caption{The plot shows each multipole weighted by the E821 beam composition for that particular multipole.  A few of the multipoles have mean values that remain relatively large (a few ppm), but these do not appear in the figure.  The reason for this is that those multipoles, mostly skew sextupole, were supressed in the distribution of muons in E821 and are expected to be similarly suppressed in E989.}
\end{figure}
